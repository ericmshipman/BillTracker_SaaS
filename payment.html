<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
        <script src="Scripts/supabase-common.js"></script>
        <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-...your-integrity-key..."
        crossorigin="anonymous"
    />
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        defer
    ></script>
      </head>
      <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
              <a class="navbar-brand" href="payments.html">Payment</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
              </button>
              
              <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item"><a class="nav-link" href="bills.html">Bills</a></li>
                  <li class="nav-item"><a class="nav-link" href="payments.html">Payments</a></li>
                  <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                </ul>
              </div>
            </div>
          </nav>
        <form id="paymentForm"  class="p-3">
            <div class="mb-3">
            <label class="form-label">Bill</label>
            <select class="form-select" id="paymentBill" onchange="defaultFromBill()">
                <option value=""></option>
            </select>
            </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="paymentName" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <input type="text" class="form-control" id="paymentNotes">
          </div>
          <div class="mb-3">
            <label class="form-label">Amount</label>
            <input type="number" step=".01" class="form-control" id="paymentAmount" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-control" id="paymentDueDate" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Planned Date</label>
            <input type="date" class="form-control" id="paymentPlannedDate" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Paid Date</label>
            <input type="date" class="form-control" id="paymentPaidDate">
          </div>
          <div class="mb-3">
            <label class="form-label">Receipt URL</label>
            <input type="text" class="form-control" id="paymentReceiptURL">
          </div>
          <button type="submit" class="btn btn-sm btn-primary">Submit</button>
          <button type="button" class="btn btn-sm btn-danger" onclick="cancelAddPayment()">Cancel</button>
        </form>
      
        <script type="module">
          async function loadPayment(id){
            const payment = await getPaymentById(id);
            if(!payment){
                alert("Payment not found");
                return;
            }
            
            listBills(payment.bill_id);
            document.getElementById("paymentName").value = payment.name;
            document.getElementById("paymentNotes").value = payment.notes;
            document.getElementById("paymentAmount").value = payment.amount;
            document.getElementById("paymentDueDate").value = payment.due_date;
            document.getElementById("paymentPlannedDate").value = payment.planned_date;
            document.getElementById("paymentReceiptURL").value = payment.receipt_url;

            document.getElementById("paymentPaidDate").value = payment.paid_date;               
          }

          const urlParams = new URLSearchParams(window.location.search);
            const paymentId = urlParams.get("id");
            if (paymentId) { loadPayment(paymentId); } else {listBills();}

          document.getElementById("paymentForm").addEventListener("submit", async (e) => {
            e.preventDefault();
      
            const payment = {
              
              name: document.getElementById("paymentName").value.trim(),
              notes: document.getElementById("paymentNotes").value.trim(),
              amount: parseFloat(document.getElementById("paymentAmount").value),
              due_date: document.getElementById("paymentDueDate").value,
              planned_date: document.getElementById("paymentPlannedDate").value,
              receipt_url: document.getElementById("paymentReceiptURL").value
            };

            if(document.getElementById("paymentPaidDate").value){
                payment.paid_date = document.getElementById("paymentPaidDate").value;
            }else{
                payment.paid_date = null;
            }

            if(document.getElementById("paymentBill").value){
                payment.bill_id = document.getElementById("paymentBill").value;
            }else{
                payment.bill_id = null;
            }

            if (!paymentId){
                await addPayment(payment);
            }else{
                await updatePayment(paymentId, payment);
            }
            
            window.location.href = "payments.html";
          });

        </script>
        <script>
                  async function defaultFromBill(){
            const id = document.getElementById("paymentBill").value;
            const bill = await getBillById(id);
            if(!bill){
                return;
            }
            document.getElementById("paymentName").value = bill.name;
            document.getElementById("paymentNotes").value = bill.notes??"";
            document.getElementById("paymentAmount").value = bill.amount;    
            const nextDate = await getNextDue(bill.due_date);
            const formatted = nextDate.toISOString().split("T")[0];
            
            console.log(nextDate);
            document.getElementById("paymentDueDate").value = formatted ;
          }

          async function getNextDue(due_date){
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                console.log(due_date);
                const billDate = new Date(due_date);
                const newDate = new Date(year, month, billDate.getDate());
                
                return newDate;
            }
        async function listBills(id){
            const bills = await getBills();
            const inputList = document.getElementById("paymentBill");
            
            bills.forEach(bill => {
                const opt = document.createElement("option");
                opt.value = bill.id
                opt.textContent = bill.name;
                if(id == bill.id){
                    opt.selected = true;
                    inputList.disabled = true;
                }
                inputList.appendChild(opt);

                
            });     
        }
            async function cancelAddPayment(){
            window.location.href = "payments.html";
          }
        </script>
      </body>
</html>